<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√≥c C·ªßa Em - Tuyen Trainer (Final Fix)</title>
    <style>
        /* --- CSS CHU·∫®N H√ìA (Mobile First) --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: #e0f7fa;
            height: 100vh; margin: 0; padding: 0;
            overflow: hidden; 
            display: flex; justify-content: center; align-items: center;
            user-select: none;
        }

        /* --- LAYERS --- */
        .layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; 
            align-items: center; justify-content: center;
        }

        /* 1. M√†n h√¨nh Ch√†o */
        #layer-start {
            display: flex; 
            background: linear-gradient(135deg, #006064, #00838f);
            z-index: 50; color: white;
        }
        
        .box {
            background: white; padding: 30px; border-radius: 20px;
            text-align: center; width: 85%; max-width: 350px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3); color: #333;
            position: relative; z-index: 65;
        }
        input {
            width: 100%; padding: 15px; font-size: 18px; margin: 20px 0;
            border: 2px solid #00acc1; border-radius: 10px; text-align: center; outline: none;
        }

        /* TH∆Ø∆†NG HI·ªÜU */
        .tuyen-brand {
            position: absolute; bottom: 30px; width: 100%; text-align: center;
            color: rgba(255, 255, 255, 0.7); font-size: 14px; font-style: italic;
            font-weight: 500; z-index: 60; pointer-events: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* 2. M√†n h√¨nh Game */
        #layer-game { background: #e0f7fa; padding-top: 10px; justify-content: flex-start; z-index: 10; }

        .info-bar {
            display: flex; justify-content: space-between; width: 95%; max-width: 600px;
            color: #006064; font-weight: bold; font-size: 18px; margin-bottom: 5px;
        }

        canvas#gameCanvas {
            background: white; border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            touch-action: none; margin-top: 5px;
            max-width: 95vw; height: auto;
        }

        /* 3. M√†n h√¨nh K·∫øt th√∫c */
        #layer-end { background: rgba(255, 255, 255, 0.98); z-index: 100; }
        
        canvas#confettiCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 90;
        }

        /* N√∫t b·∫•m */
        .btn-main { 
            background: #d32f2f; color: white; border: none; padding: 15px; width: 100%;
            font-size: 18px; font-weight: bold; border-radius: 50px; 
            box-shadow: 0 4px 0 #b71c1c; cursor: pointer; transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.95); box-shadow: none; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; width: 100%; }
        .btn-opt { 
            background: #0097a7; color: white; border: none; padding: 15px;
            font-size: 16px; font-weight: bold; border-radius: 10px; 
            box-shadow: 0 4px 0 #006064; transition: transform 0.1s;
        }
        .btn-opt:active { transform: translateY(4px); box-shadow: none; }
        .btn-opt:disabled { background: #ccc; box-shadow: none; color: #777; }

        #question-area {
            display: none; width: 95%; max-width: 600px;
            background: #fff; padding: 15px; border-radius: 15px;
            margin-top: 15px; border: 2px solid #b2ebf2;
            animation: popIn 0.3s;
        }
        
        #msg-feedback { height: 25px; margin-top: 10px; font-weight: bold; font-size: 18px; color: #333; text-align: center;}

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <canvas id="confettiCanvas"></canvas>

    <div id="layer-start" class="layer">
        <div class="box">
            <h2 style="color:#006064; margin:0;">G√ìC C·ª¶A EM</h2>
            <p style="color:#666;">Nh·∫≠p t√™n ƒë·ªÉ th·∫ßy g·ªçi nh√©:</p>
            <input type="text" id="inp-name" placeholder="V√≠ d·ª•: B·∫£o An">
            <button class="btn-main" onclick="initGame()">V√ÄO H·ªåC NGAY ‚ñ∂</button>
        </div>
        <div class="tuyen-brand">¬© D·ª± √°n th·ª≠ nghi·ªám c·ªßa Tuyen Trainer</div>
    </div>

    <div id="layer-game" class="layer">
        <div class="info-bar">
            <span id="txt-name">HS: ...</span>
            <span id="txt-score">ƒêi·ªÉm: 0</span>
        </div>
        <div style="font-size:14px; color:#555; margin-bottom:5px;">L∆∞·ª£t: <span id="txt-turn">1</span>/5</div>
        
        <canvas id="gameCanvas" width="600" height="450"></canvas>
        
        <div id="msg-feedback"></div>

        <div id="question-area">
            <div style="font-size:20px; font-weight:bold; color:#333; text-align: center;">
                G√≥c <span style="color:red">xOy</span> l√† g√≥c g√¨?
            </div>
            <div class="btn-grid">
                <button class="btn-opt" id="btn-nhon" onclick="checkAnswer('nhon')">G√≥c Nh·ªçn</button>
                <button class="btn-opt" id="btn-vuong" onclick="checkAnswer('vuong')">G√≥c Vu√¥ng</button>
                <button class="btn-opt" id="btn-tu" onclick="checkAnswer('tu')">G√≥c T√π</button>
                <button class="btn-opt" id="btn-bet" onclick="checkAnswer('bet')">G√≥c B·∫πt</button>
            </div>
        </div>
    </div>

    <div id="layer-end" class="layer">
        <div class="box">
            <h1 style="color:#d32f2f; margin:0;">üéâ HOAN H√î üéâ</h1>
            <h3 id="end-msg" style="color:#006064;">Ch√∫c m·ª´ng con!</h3>
            <div style="font-size:60px; color:#fbc02d; font-weight:bold; margin: 15px 0; text-shadow: 2px 2px #333;">
                <span id="end-score">0</span><span style="font-size:24px; color:#999;">/50</span>
            </div>
            <button class="btn-main" onclick="location.reload()">CH∆†I L·∫†I ‚Ü∫</button>
        </div>
    </div>

    <script>
        // === 1. C·∫§U H√åNH (ƒê√£ tƒÉng ƒë·ªô d√†i) ===
        const config = { 
            rayLen: 260, // TƒÉng t·ª´ 210 l√™n 260 (D√†i h∆°n ~25%)
            cx: 300,     // T√¢m X
            cy: 380,     // T√¢m Y
            handleRadius: 45
        };
        
        let state = {
            name: 'H·ªçc sinh', score: 0, turn: 1, angle: 45,
            isDragging: false, canInteract: true, audioCtx: null
        };

        const cvs = document.getElementById('gameCanvas');
        const ctx = cvs.getContext('2d');
        
        const uiStart = document.getElementById('layer-start');
        const uiGame = document.getElementById('layer-game');
        const uiEnd = document.getElementById('layer-end');
        const uiQues = document.getElementById('question-area');
        const uiFeed = document.getElementById('msg-feedback');

        // === 2. √ÇM THANH ===
        function initAudio() {
            try {
                if (!state.audioCtx) state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (state.audioCtx.state === 'suspended') state.audioCtx.resume();
            } catch(e) {}
        }

        function playTickSound() {
            if (!state.audioCtx) return;
            try {
                const now = state.audioCtx.currentTime;
                const osc = state.audioCtx.createOscillator();
                const gain = state.audioCtx.createGain();
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.connect(gain); gain.connect(state.audioCtx.destination);
                osc.start(now); osc.stop(now + 0.05);
            } catch(e) {}
        }

        function playWinSound() {
            if (!state.audioCtx) return;
            try {
                const now = state.audioCtx.currentTime;
                const osc = state.audioCtx.createOscillator();
                const gain = state.audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now+0.2);
                gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.5);
                osc.connect(gain); gain.connect(state.audioCtx.destination);
                osc.start(now); osc.stop(now + 0.5);
            } catch(e) {}
        }

        function speak(text) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'vi-VN'; window.speechSynthesis.speak(u);
        }

        // === 3. GAME LOGIC ===
        function initGame() {
            const val = document.getElementById('inp-name').value.trim();
            if (val) state.name = val;
            initAudio();
            uiStart.style.display = 'none';
            uiGame.style.display = 'flex';
            document.getElementById('txt-name').innerText = "HS: " + state.name;
            draw();
            speak(`Ch√†o m·ª´ng ${state.name}. H√£y k√©o ch·∫•m ƒë·ªè.`);
            uiFeed.innerText = "üëá K√©o ch·∫•m ƒë·ªè ƒë·ªÉ t·∫°o g√≥c üëá";
        }

        function draw() {
            ctx.fillStyle = '#fafafa'; ctx.fillRect(0, 0, cvs.width, cvs.height);

            // 1. Ox
            ctx.beginPath(); ctx.moveTo(config.cx, config.cy); ctx.lineTo(config.cx + config.rayLen, config.cy);
            ctx.lineWidth = 6; ctx.strokeStyle = '#455a64'; ctx.lineCap = 'round'; ctx.stroke();
            ctx.fillStyle = '#455a64'; ctx.font = "bold 24px Arial"; ctx.fillText("x", config.cx + config.rayLen - 15, config.cy + 35);

            // 2. Oy
            const rad = -state.angle * (Math.PI / 180);
            const ex = config.cx + config.rayLen * Math.cos(rad);
            const ey = config.cy + config.rayLen * Math.sin(rad);
            ctx.beginPath(); ctx.moveTo(config.cx, config.cy); ctx.lineTo(ex, ey);
            ctx.strokeStyle = '#d32f2f'; ctx.stroke();
            ctx.fillStyle = '#d32f2f'; ctx.fillText("y", ex + 20*Math.cos(rad), ey + 20*Math.sin(rad));

            // 3. Cung tr√≤n
            if (state.angle > 0) {
                ctx.beginPath(); ctx.arc(config.cx, config.cy, 80, 0, rad, true);
                ctx.strokeStyle = '#ffa000'; ctx.lineWidth = 4; ctx.setLineDash([8,6]); ctx.stroke(); ctx.setLineDash([]);
            }

            // 4. S·ªë ƒëo
            ctx.fillStyle = "#00838f"; ctx.font = "bold 45px Arial"; ctx.fillText(state.angle + "¬∞", config.cx + 50, config.cy - 80);

            // 5. T√¢m O
            ctx.beginPath(); ctx.arc(config.cx, config.cy, 10, 0, Math.PI*2); ctx.fillStyle = '#263238'; ctx.fill();
            ctx.font = "bold 24px Arial"; ctx.fillText("O", config.cx - 30, config.cy + 30);

            // 6. Tay n·∫Øm (Handle)
            if (state.canInteract) {
                const handleDist = config.rayLen - 20; 
                const hx = config.cx + handleDist * Math.cos(rad);
                const hy = config.cy + handleDist * Math.sin(rad);
                
                // V√πng b√≥ng m·ªù
                ctx.beginPath(); ctx.arc(hx, hy, 30, 0, Math.PI*2); ctx.fillStyle = 'rgba(211,47,47,0.2)'; ctx.fill();
                // ƒêi·ªÉm ch√≠nh
                ctx.beginPath(); ctx.arc(hx, hy, 14, 0, Math.PI*2); ctx.fillStyle = '#d32f2f'; ctx.fill(); 
                ctx.strokeStyle = 'white'; ctx.lineWidth=3; ctx.stroke();
            }
        }

        // === 4. X·ª¨ L√ù C·∫¢M ·ª®NG (QUAN TR·ªåNG: FIX L·ªñI 180 -> 0) ===
        function getPos(e) {
            const rect = cvs.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (cx - rect.left) * (cvs.width / rect.width),
                y: (cy - rect.top) * (cvs.height / rect.height)
            };
        }

        function onStart(e) {
            if (!state.canInteract) return;
            e.preventDefault();
            const p = getPos(e);
            
            const rad = -state.angle * (Math.PI / 180);
            const handleDist = config.rayLen - 20;
            const hx = config.cx + handleDist * Math.cos(rad);
            const hy = config.cy + handleDist * Math.sin(rad);
            
            const dist = Math.sqrt((p.x - hx)**2 + (p.y - hy)**2);
            if (dist < 80) { 
                state.isDragging = true;
                uiQues.style.display = 'none';
                uiFeed.innerText = "ƒêang m·ªü g√≥c...";
            }
        }

        function onMove(e) {
            if (!state.isDragging) return;
            e.preventDefault();
            const p = getPos(e);
            
            const dx = p.x - config.cx;
            const dy = p.y - config.cy;
            
            // T√≠nh to√°n g√≥c th√¥
            let theta = Math.atan2(-dy, dx); 
            let deg = Math.round(theta * 180 / Math.PI);

            // === FIX L·ªñI 180 ƒê·ªò ===
            // N·∫øu k√©o xu·ªëng d∆∞·ªõi ƒë∆∞·ªùng ngang (y > cy), g√≥c s·∫Ω b·ªã √¢m.
            // N·∫øu ·ªü b√™n tr√°i (dx < 0) m√† b·ªã √¢m -> Nghƒ©a l√† k√©o qu√° 180 ƒë·ªô m·ªôt ch√∫t -> √âp v·ªÅ 180.
            // N·∫øu ·ªü b√™n ph·∫£i (dx > 0) m√† b·ªã √¢m -> Nghƒ©a l√† k√©o qu√° 0 ƒë·ªô m·ªôt ch√∫t -> √âp v·ªÅ 0.
            if (deg < 0) {
                if (dx < 0) deg = 180; // B√™n tr√°i
                else deg = 0;          // B√™n ph·∫£i
            }

            // Ch·∫∑n tr√™n d∆∞·ªõi ch·∫Øc ch·∫Øn
            if (deg > 180) deg = 180;

            if (deg !== state.angle) {
                if (Math.abs(deg - state.angle) >= 1) playTickSound(); 
                state.angle = deg;
                draw();
            }
        }

        function onEnd(e) {
            if (!state.isDragging) return;
            state.isDragging = false;
            uiQues.style.display = 'block';
            uiFeed.innerText = "G√≥c n√†y l√† g√≥c g√¨?";
            speak(`G√≥c ${state.angle} ƒë·ªô l√† g√≥c g√¨?`);
            setTimeout(() => uiQues.scrollIntoView({behavior:"smooth"}), 100);
        }

        cvs.addEventListener('mousedown', onStart); cvs.addEventListener('touchstart', onStart, {passive: false});
        window.addEventListener('mousemove', onMove, {passive: false}); window.addEventListener('touchmove', onMove, {passive: false});
        window.addEventListener('mouseup', onEnd); window.addEventListener('touchend', onEnd);

        // === 5. CHECK ANSWER ===
        function checkAnswer(choice) {
            if (!state.canInteract) return;
            state.canInteract = false;
            
            let correct = '';
            if (state.angle > 0 && state.angle < 90) correct = 'nhon';
            else if (state.angle === 90) correct = 'vuong';
            else if (state.angle > 90 && state.angle < 180) correct = 'tu';
            else if (state.angle === 180) correct = 'bet';

            document.querySelectorAll('.btn-opt').forEach(b => b.disabled = true);
            const btn = document.getElementById('btn-' + choice);

            if (choice === correct) {
                state.score += 10;
                document.getElementById('txt-score').innerText = "ƒêi·ªÉm: " + state.score;
                uiFeed.innerHTML = "<span style='color:green'>CH√çNH X√ÅC!</span>";
                btn.style.background = "#2e7d32";
                playWinSound(); speak("Ch√≠nh x√°c!");
            } else {
                uiFeed.innerHTML = "<span style='color:red'>SAI R·ªíI!</span>";
                btn.style.background = "#c62828";
                document.getElementById('btn-'+correct).style.background = "#2e7d32";
                speak("Sai r·ªìi.");
            }
            setTimeout(nextTurn, 2500);
        }

        function nextTurn() {
            if (state.score >= 50 || state.turn >= 5) { endGame(); return; }
            state.turn++;
            document.getElementById('txt-turn').innerText = state.turn;
            state.canInteract = true;
            uiQues.style.display = 'none';
            uiFeed.innerText = "K√©o g√≥c ti·∫øp theo...";
            document.querySelectorAll('.btn-opt').forEach(b => { b.disabled = false; b.style.background = "#0097a7"; });
            state.angle = Math.floor(Math.random() * 160) + 10;
            draw();
            speak("C√¢u ti·∫øp theo.");
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // === 6. END GAME ===
        function endGame() {
            uiGame.style.display = 'none';
            uiEnd.style.display = 'flex';
            document.getElementById('end-score').innerText = state.score;
            document.getElementById('end-msg').innerText = `Ch√∫c m·ª´ng ${state.name}!`;
            speak(`Ch√∫c m·ª´ng b·∫°n ${state.name} ƒë√£ ho√†n th√†nh.`);
            startConfetti();
        }

        function startConfetti() {
            const cc = document.getElementById('confettiCanvas');
            const cCtx = cc.getContext('2d');
            cc.width = window.innerWidth; cc.height = window.innerHeight;
            let particles = [];
            const colors = ['#f44336', '#2196f3', '#ffeb3b', '#4caf50', '#ff9800'];
            for(let i=0; i<200; i++) {
                particles.push({
                    x: Math.random()*cc.width, y: Math.random()*cc.height - cc.height,
                    color: colors[Math.floor(Math.random()*colors.length)],
                    size: Math.random()*10+5, speed: Math.random()*5+2, angle: Math.random()*360
                });
            }
            function animate() {
                cCtx.clearRect(0,0,cc.width,cc.height);
                particles.forEach(p => {
                    p.y += p.speed; p.angle += 2;
                    if(p.y > cc.height) p.y = -20;
                    cCtx.save();
                    cCtx.translate(p.x, p.y); cCtx.rotate(p.angle * Math.PI/180);
                    cCtx.fillStyle = p.color; cCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    cCtx.restore();
                });
                requestAnimationFrame(animate);
            }
            animate();
        }
                // --- BI·∫æN TO√ÄN C·ª§C ƒê·ªÇ L∆ØU GI·ªåNG ---
        let vnVoice = null;

        // --- H√ÄM T·∫¢I GI·ªåNG (CH·∫†Y NG·∫¶M) ---
        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            // T√¨m gi·ªçng c√≥ ch·ªØ 'vi', 'VN', ho·∫∑c 'Vietnamese'
            vnVoice = voices.find(v => v.lang.includes('vi') || v.lang.includes('VN'));
            
            // N·∫øu t√¨m th·∫•y, in ra log ƒë·ªÉ bi·∫øt (d√πng khi debug)
            if (vnVoice) console.log("ƒê√£ t√¨m th·∫•y gi·ªçng: " + vnVoice.name);
        }

        // ƒê·ª£i tr√¨nh duy·ªát n·∫°p xong danh s√°ch gi·ªçng th√¨ m·ªõi t√¨m
        if ('speechSynthesis' in window) {
             window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        // --- H√ÄM ƒê·ªåC M·ªöI (TH√îNG MINH H∆†N) ---
        function speak(text) {
            if (!('speechSynthesis' in window)) return;
            
            // N·∫øu ch∆∞a c√≥ gi·ªçng, th·ª≠ t√¨m l·∫°i l·∫ßn n·ªØa
            if (!vnVoice) loadVoices();

            window.speechSynthesis.cancel(); // Ng·∫Øt l·ªùi c≈©
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'vi-VN'; // C·ªë ƒë·ªãnh m√£ ng√¥n ng·ªØ
            
            // N·∫øu t√¨m th·∫•y gi·ªçng ch·ªã Google x·ªãn th√¨ d√πng, kh√¥ng th√¨ d√πng m·∫∑c ƒë·ªãnh
            if (vnVoice) u.voice = vnVoice;
            
            u.rate = 1.0; // T·ªëc ƒë·ªô ƒë·ªçc
            window.speechSynthesis.speak(u);
        }

    </script>
</body>
</html>
